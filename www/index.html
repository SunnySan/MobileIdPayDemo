<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mobile ID Pay</title>
	<link rel="stylesheet" href="./css/jquery.mobile-1.4.5.min.css">
	<link rel="stylesheet" href="./css/custom.css">

	<script src="./js/jquery.min.js"></script>
	<script src="./js/jquery.mobile-1.4.5.min.js"></script>
</head>

<body style="background-color: transparent;">

<!-- Start of first page -->
<div data-role="page" id="main">

	<div data-role="header">
		<h1>Mobile ID Pay</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content" style="text-align:center;">
		<div style="padding:24px 24px 12px 24px;"><img src="images/qrcode128.png" /></div>
		<p style="padding:12px 24px 12px 24px;">Scan the QR code on the goods and make payment.</p>
		<div style="padding:24px 24px 24px 24px;"><button class="ui-btn ui-btn-inline" onclick="location.href='scan.html';">Scan QR code</button></div>
	</div><!-- /content -->

	<div data-role="footer" data-theme="a" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#main" data-icon="main" class="ui-btn-active ui-state-persist">QR Code</a></li>
				<li><a href="#myid" data-icon="myid">My Card</a></li>
				<li><a href="#transactions" data-icon="transactions">Transactions</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of Payment Confirm page -->
<div data-role="page" id="payment-confirm">

	<div data-role="header">
		<h1>Mobile ID Pay</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content" style="text-align:center;">
		<div style="padding:24px 24px 12px 24px;"><img id="goodsImage" src="" style="width:128px;height:128px;" /></div>
	</div><!-- /content -->

	<div data-role="footer" data-theme="a" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#main" data-icon="main" class="ui-btn-active ui-state-persist">QR Code</a></li>
				<li><a href="#myid" data-icon="myid">My Card</a></li>
				<li><a href="#transactions" data-icon="transactions">Transactions</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of second page -->
<div data-role="page" id="myid">

	<div data-role="header">
		<h1>Mobile ID Pay</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<p>I'm first in the source order so I'm shown as the page.</p>
		<p>View internal page called <a href="#bar">bar</a></p>
	</div><!-- /content -->

	<div data-role="footer" data-theme="a" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#main" data-icon="main">QR Code</a></li>
				<li><a href="#myid" data-icon="myid" class="ui-btn-active ui-state-persist">My Card</a></li>
				<li><a href="#transactions" data-icon="transactions">Transactions</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of third page -->
<div data-role="page" id="transactions">

	<div data-role="header">
		<h1>Mobile ID Pay</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content">
		<p>I'm first in the source order so I'm shown as the page.</p>
		<p>View internal page called <a href="#bar">bar</a></p>
	</div><!-- /content -->

	<div data-role="footer" data-theme="a" data-position="fixed">
		<div data-role="navbar">
			<ul>
				<li><a href="#main" data-icon="main">QR Code</a></li>
				<li><a href="#myid" data-icon="myid">My Card</a></li>
				<li><a href="#transactions" data-icon="transactions" class="ui-btn-active ui-state-persist">Transactions</a></li>
			</ul>
		</div><!-- /navbar -->
	</div><!-- /footer -->
</div><!-- /page -->

</body>
</html>

<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/utility.js"></script>

<script>
	$(function () {
		document.addEventListener('deviceready', initCamera, false);
	});
	
	function initCamera(){
		//$.mobile.urlHistory.clearForward();
		QRScanner.prepare(onDone); // show the prompt
		var s = getParameterByName("goodsurl");
		if (notEmpty(s) && s.indexOf("ajaxGetMyGoods")>0){
			gotoPaymentConfirmPage(s);
		}
	}
 
	function onDone(err, status){
		if (err) {
			// here we can handle errors and clean up any loose ends.
			navigator.notification.alert(err);
			console.error(err);
		}
		if (status.authorized) {
			// W00t, you have camera access and the scanner is initialized.
			// QRscanner.show() should feel very fast.
			//navigator.notification.alert("ok");
		} else if (status.denied) {
			QRScanner.openSettings();
			// The video preview will remain black, and scanning is disabled. We can
			// try to ask the user to change their mind, but we'll have to send them
			// to their device settings with `QRScanner.openSettings()`.
		} else {
			// we didn't get permission, but we didn't get permanently denied. (On
			// Android, a denial isn't permanent unless the user checks the "Don't
			// ask again" box.) We can ask again at the next relevant opportunity.
		}
	}
	
	function gotoPaymentConfirmPage(goodsurl){
		showPage("payment-confirm");
		var sData = "";

		getDataFromServer(goodsurl, sData, "json", function(data){
			if (!data.resultCode || !data.resultText){
	            navigator.notification.alert("Unable to get goods information!", null, "System Message", "OK");
				return;
			}else{
				if (data.resultCode=="00000"){
	                var goodsId = data.id;
	                var txtName = data.name;
	                var txtPrice = data.price;
	                var txtDescription = data.description;
	                var img = data.picture;
                	$('#goodsImage').attr("src", img);
				}else if (data.resultCode=="00006"){
					window.plugins.toast.show('No data found!', 'short', 'bottom', null, null);
				}else{
		            navigator.notification.alert("Fail to get goods information: " + data.resultText, null, "System Message", "OK");
				}
			}

		});	//getDataFromServer("xxx.jsp", sData, "json", function(data){

	}
	
</script>
